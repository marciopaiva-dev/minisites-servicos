<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de MiniSite</title>
  <meta name="description" content="Gere automaticamente um MiniSite com WhatsApp e proposta em DOCX." />
  <style>
    body{background:#0f172a;color:#fff;font-family:Arial,system-ui,sans-serif;margin:0}
    .container{max-width:720px;margin:0 auto;padding:24px}
    h1{color:#facc15;margin:0 0 10px}
    p.lead{color:#9fb4ca;margin:0 0 16px}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:0;font-size:16px;color:#0f172a}
    button{width:100%;margin-top:14px;padding:12px;border:0;border-radius:10px;background:#facc15;font-weight:800;cursor:pointer}
    button:hover{background:#eab308}
    .resultado{display:none;margin-top:16px;background:#111827;border:1px solid #233045;border-radius:10px;padding:12px}
    .erro{color:#f87171;font-weight:700}
    .sucesso{color:#22c55e;font-weight:700}
    .link{display:flex;gap:8px;align-items:center;margin-top:8px}
    .link code{color:#ffe082;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .btn-sm{padding:8px 10px;border-radius:8px;border:1px solid #233045;background:#0b1220;color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Gerador de MiniSite</h1>
    <p class="lead">Preencha os campos e gere automaticamente uma landing page com WhatsApp e, se habilitado, uma proposta em DOCX.</p>

    <label for="servico">T√≠tulo do servi√ßo</label>
    <input id="servico" placeholder="Ex.: Designer Gr√°fico" />

    <label for="descricaoCurta">Descri√ß√£o curta (m√°x. 160 caracteres)</label>
    <textarea id="descricaoCurta" maxlength="160" placeholder="Ex.: Cria√ß√£o de artes para redes sociais"></textarea>

    <label for="whats">WhatsApp com DDD</label>
    <input id="whats" placeholder="(48) 99999-8889" />

    <button id="btn">Criar MiniSite</button>

    <div id="resultado" class="resultado"></div>
  </div>

  <script>
  const ENDPOINT = "/api/gerar";
  const $ = (id) => document.getElementById(id);

  function setLoading(is) {
    const btn = $("btn");
    btn.disabled = is;
    btn.textContent = is ? "Gerando..." : "Criar MiniSite";
  }

  async function copyToClipboard(text, btnEl) {
    try {
      await navigator.clipboard.writeText(text);
      btnEl.textContent = "Copiado!";
    } catch {
      btnEl.textContent = "Falhou :(";
    } finally {
      setTimeout(() => (btnEl.textContent = "Copiar"), 1200);
    }
  }

  $("btn").addEventListener("click", async () => {
    const servico = $("servico").value.trim();
    const descricaoCurta = $("descricaoCurta").value.trim();
    const whats = $("whats").value.replace(/\D/g, "");

    const r = $("resultado");
    r.style.display = "block";
    r.className = "resultado";

    // valida√ß√£o simples
    if (!servico || !descricaoCurta || !whats) {
      r.innerHTML = `<div class="erro">‚ùå Preencha todos os campos.</div>`;
      return;
    }

    r.textContent = "Gerando MiniSite...";
    setLoading(true);

    try {
      const resp = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ servico, descricaoCurta, whats })
      });

      // se a API responder com texto vazio, evita .json() quebrar
      let data = {};
      try { data = await resp.json(); } catch { /* segue vazio */ }

      if (!resp.ok || !data.ok) {
        const msg = data?.error || data?.mensagem || `Falha (HTTP ${resp.status})`;
        r.innerHTML = `<div class="erro">‚ùå Erro ao gerar o MiniSite: ${msg}</div>`;
        return;
      }

      // üîë link final (ordem de prefer√™ncia)
      const previewUrl =
        (data && (data.urlFinal || (data.outputs && data.outputs.previewUrl) || data.url)) || "";
      const docxUrl = (data && data.outputs && data.outputs.docxUrl) || "";

      let html = `<div class="sucesso">‚úÖ MiniSite gerado!</div>`;

      if (previewUrl) {
        html += `
          <div class="link">
            <span>MiniSite:</span>
            <code title="${previewUrl}">${previewUrl}</code>
            <a class="btn-sm" href="${previewUrl}" target="_blank" rel="noopener">Abrir</a>
            <button class="btn-sm" id="copyMini" type="button">Copiar</button>
          </div>`;
      } else {
        html += `<div class="link"><span>MiniSite:</span><code>(publicando... tente em alguns segundos)</code></div>`;
      }

      if (docxUrl) {
        html += `
          <div class="link">
            <span>DOCX:</span>
            <code title="${docxUrl}">${docxUrl}</code>
            <a class="btn-sm" href="${docxUrl}" target="_blank" rel="noopener">Abrir</a>
            <button class="btn-sm" id="copyDocx" type="button">Copiar</button>
          </div>`;
      }

      r.innerHTML = html;

      // handlers de copiar
      const copyMini = $("copyMini");
      if (copyMini && previewUrl)
        copyMini.onclick = () => copyToClipboard(previewUrl, copyMini);

      const copyDocx = $("copyDocx");
      if (copyDocx && docxUrl)
        copyDocx.onclick = () => copyToClipboard(docxUrl, copyDocx);

    } catch (e) {
      r.innerHTML = `<div class="erro">‚ùå Erro (JS): ${e?.message || e}</div>`;
    } finally {
      setLoading(false);
    }
  });
</script>
</body>
</html>
